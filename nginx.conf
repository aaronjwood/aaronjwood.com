worker_processes 4;

events {
	worker_connections 1024;
}

http {
	sendfile        on;

	gzip  on;
	gzip_http_version  1.1;
	gzip_comp_level    5;
	gzip_min_length    256;
	gzip_proxied       any;
	gzip_vary          on;
	gzip_types
	application/atom+xml
	application/javascript
	application/json
	application/rss+xml
	application/vnd.ms-fontobject
	application/x-font-ttf
	application/x-web-app-manifest+json
	application/xhtml+xml
	application/xml
	text/javascript
	font/opentype
	image/svg+xml
	image/x-icon
	text/css
	text/plain
	text/x-component;

	proxy_cache_path /tmp/ajw levels=1:2 keys_zone=ajw:10m inactive=1w max_size=1g;
	proxy_cache_path /tmp/media levels=1:2 keys_zone=media:10m inactive=1w max_size=1g;

	server {
		listen 80;
		server_name aaronjwood.com;
		return 301 https://aaronjwood.com$request_uri;
	}

	server {
		listen 443 ssl http2;
		server_name aaronjwood.com;
		ssl_certificate /etc/nginx/ssl/fullchain.pem;
		ssl_certificate_key /etc/nginx/ssl/privkey.pem;

		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
		ssl_prefer_server_ciphers on;
		ssl_dhparam /etc/nginx/ssl/dhparam.pem;
		ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
		ssl_ecdh_curve secp384r1;
		ssl_session_cache shared:SSL:10m;
		ssl_session_tickets off;
		ssl_stapling on;
		ssl_stapling_verify on;
		add_header Strict-Transport-Security "max-age=63072000; preload";
		add_header X-Frame-Options DENY;
		add_header X-Content-Type-Options nosniff;

		proxy_cache ajw;
		proxy_cache_valid 200 1d;
		proxy_cache_revalidate on;
		proxy_cache_methods GET HEAD POST;
		proxy_cache_key "$request_uri|$request_body";
		proxy_cache_lock on;
		proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
		add_header X-Cache-Status $upstream_cache_status;

		location ~*  \.(jpg|jpeg|png|gif|ico|css|js)$ {
			expires 365d;
			proxy_pass http://172.18.0.2:5000;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}

		location / {
			proxy_pass http://172.18.0.2:5000;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}
	}

	server {
		listen 80;
		server_name media.aaronjwood.com;
		return 301 https://media.aaronjwood.com$request_uri;
	}

	server {
		listen 443 ssl http2;
		ssl_certificate /etc/nginx/ssl/fullchain.pem;
		ssl_certificate_key /etc/nginx/ssl/privkey.pem;

		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
		ssl_prefer_server_ciphers on;
		ssl_dhparam /etc/nginx/ssl/dhparam.pem;
		ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
		ssl_ecdh_curve secp384r1;
		ssl_session_cache shared:SSL:10m;
		ssl_session_tickets off;
		ssl_stapling on;
		ssl_stapling_verify on;
		add_header X-Frame-Options DENY;
		add_header X-Content-Type-Options nosniff;
		server_name media.aaronjwood.com;
		proxy_cache media;
		proxy_cache_valid 200 1d;
		proxy_cache_revalidate on;
		proxy_cache_lock on;
		proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
		add_header X-Cache-Status $upstream_cache_status;

		location / {
			if ($http_x_plex_device_name = '') {
				rewrite ^/$ http://$http_host/web/index.html;
			}

			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Plex-Client-Identifier $http_x_plex_client_identifier;
			proxy_set_header Host $http_host;

			proxy_pass http://172.18.0.3:32400/;

			proxy_redirect off;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
		}
		location ~*  \.(jpg|jpeg|png|gif|ico|css|js)$ {
			expires 365d;
			if ($http_x_plex_device_name = '') {
				rewrite ^/$ http://$http_host/web/index.html;
			}

			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Plex-Client-Identifier $http_x_plex_client_identifier;
			proxy_set_header Host $http_host;

			proxy_pass http://172.18.0.3:32400;

			proxy_redirect off;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
		}
	}
}

